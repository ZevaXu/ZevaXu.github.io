# 计算机网络：可靠数据传输协议原理


# 可靠数据传输协议原理



## 构造可靠传输协议

可靠数据传输协议是由 检验和、序号、定时器、肯定和否定确认这几个机制来确保的。

其中检验和用于接收方判断分组是否发生错误，序号帮助发送方决定重新发送哪个分组，接收方发送肯定和否定确认告诉发送方是否正确接收到了分组。

<img title="" src="https://i.imgur.com/QqZzMDd.jpg" alt="QqZzMDd" data-align="center" width="384">

将发送方称为S，接收方成为R，考虑以上几种情况：

1. **一切正常**
   
   S向R发送0号分组，R收到了分组，利用检验和判断分组是否正确，如果正确，R向S发送一个0号分组的ACK确认分组，告诉S已经收到了正确分组。S再向R发送下一个分组1。

2. **分组丢失**
   
   S向R发送0号分组，此时S的定时器开始计时，0号分组在传输过程中丢失，R没有收到任何数据，所以也没有向S发送任何确认信号。当计时器停止时，S向R在发送一个0号分组。

3. **ACK丢失**
   
   S向R发送0号分组，并开启了定时器。R收到了分组，并回传一个ACK信号，但是信号在传输过程中丢失，当S的定时器停止时，S会再向R发送相同分组，此时R再次收到了相同的分组，开启冗余检测机制，会丢弃冗余的分组。

4. **过早超时**
   
   S向R发送0号分组，并开启了定时器。R收到了分组，并回传一个ACK信号，但是信号在传输过程中超时，S又发了一个相同的分组给R，之后S收到该上一个分组ACK，但是它什么也不做。

## 流水线可靠数据传输协议

如果采取“可靠数据传输协议”：接收一个分组，等待一个ACK到达后，再发送下一个分组的方式，发送发大部分时间都处于等待中，会带来有效吞吐量小，发送方利用率低的缺陷。

引入流水线技术有助于解决这种缺陷。即不以停等的方式运行，允许发送方发送多个分组而无须等待确认。

这样的技术提出如下几个要求：

1. **增加序号的范围**，每个分组必须有一个唯一的序号，有多个再输送中而未被确认的分组
2. **发送方和接收方两端需要缓存多个分组**。发送方最低限度要缓存那些已经发送但没有确认的分组。

解决流水线的差错恢复有两种基本方法：**回退N步（go-back-N,GBN)、选择重传(Selective Repeat,SR)**

### GBN(回退N步)

<img src="https://i.imgur.com/V542oJZ.jpg" title="" alt="V542oJZ" data-align="center">

**窗口长度N**由包括两部分（已发送但未被确认的分组和可用但是还没有发送的分组序号）组成。

一个分组的序号承载在分组首部的一个固定长度字段中规定，例如如果只分配1比特给这个字段，那么这个序号空间只能是0和1。

GBN的运行过程如下图：

<img title="" src="https://i.imgur.com/5RrU2FL.jpg" alt="5RrU2FL" data-align="center" width="391">

发送方批量发送多个分组，并为每个已经发送的分组开启一个定时器，接收方按序接收分组，每接收到一个分组，发送一个ACK。

例如发送方批量发送了0—4号分组，其中3号分组丢失。

对于发送方：它的3号计时器到期后，就把3号及3号之后的分组再重新发送；

对于接收方：它收到了0、1、2号分组，每收到一个就发送该分组的ACK。由于未收到3号分组，它接收到4号分组后，把4号分组丢弃，再发送上一个正确分组的ACK，即2号ACK。直到接收到3号分组为止。

GBN协议允许发送方用多个分组填充流水线，因此避免了停等协议中的信道利用率问题，使用到了序号、累计确认、检验和、超时重传操作等技术。

### 选择重传

GBN协议也存在一些性能问题，当窗口长度和传输时延过大时，单个分组的差错带来的大量不必要重传的分组再次重传。

选择重传协议通过让接收方缓存没有确认的分组以及维护一个窗口的方式，实现发送方仅仅重传接收方没有收到或者受损的分组。

<img src="https://i.imgur.com/in15Xwu.jpg" title="" alt="in15Xwu" data-align="center">

<img title="" src="https://i.imgur.com/vnS3xcf.jpg" alt="vnS3xcf" data-align="center" width="465">

<img src="https://tva1.sinaimg.cn/large/008i3skNgy1gvw5ud5c32j316u0km434.jpg" title="" alt="" data-align="center">

**分组重新排序问题：**

分组重新排序的表现：一个具有序号或者确认号x的分组的旧副本可能突然出现。

当信道是一个网络时，分组重新排序是可能发生的，此时，网络相当于缓存了分组，并随时可能把分组释放出来。

解决：

确保一个序号不被重新使用，假定分组在网络中的存活时间最大为3分钟。


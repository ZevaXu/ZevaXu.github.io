# 计算机网络：网络层协议


# 网络层协议

​

控制平面作为一种网络范围的逻辑，不仅控制沿着从源主机到目的主机的端到端路径间的路由器如何转发数据报，而且控制网络层组件和服务如何配置和管理。

**OSPF**是一种运行在单一ISP的网络中的路由选择算法。**BGP**是一种在因特网中用于 互联所有网络的路由选择算法，因此常被称为因特网的“黏合剂” 。

## 5.2 路由选择算法

其目的是从发送方到接收方的过程中确定一条通过路由器网络的好的路径(等价于路由)。通常，一条好路径指具有最低开销的路径。

#### 分类

1. 根据该算法是集中式还是分散式
   - 集中式路由选择算法：用完整的、全局性的网络知识计算岀从源到目的地之间的最低开销路径。 要求该算法在真正开始计算以前，要以某种方式获得这些信息。 具有全局状态信息的算法常被称作链路状态(Link State, LS) 算法。
   - 分散式路由选择算法：没有节点拥有关于所有网络链路开销的完整信息。 相反，每个节点仅有与其直接相连链路的开销知识即可开始工作。然后，通过迭 代计算过程以及与相邻节点的信息交换，一个节点逐渐计算出到达某目的节点或 一组目的节点的最低开销路径。
2. 根据算法是静态的还是动态
   - 在静态路由选择算法(static routing algorithm)：路由随时间的变化非常缓慢，通常是人工进行调整(如人为手工编辑一条链路开销) 。
   - 动态路由选择算法(dynamic routing algorithm) ：随着网络流量负载或拓扑发生变化而改变路由选择路径。一个动态算法可周期性地运行或直接响应拓扑或链路开销的变化而运行。
3. 根据它是负载敏感的还是负载迟钝的进行划分
   - 负载敏感算法：链路开销会动态地变化以反映出底层链路的当前拥塞水平。如果当前拥塞的一条链路与高开销相联系，则路由选择算法趋向于绕开该 拥塞链路来选择路由。
   - 负载迟钝算法：某条链路的开销不明确反映当前或者最近的拥塞水平。

### 5.2.2 距离向量路由选择算法

![bSMhkzI](https://i.imgur.com/bSMhkzI.png)

![pLWMUeP](https://i.imgur.com/pLWMUeP.png)

![LO4SLaQ](https://i.imgur.com/LO4SLaQ.png)

## 5.3 因特网中自治系统内部的路由选择:**OSPF**

上述讨论的LS（狄杰斯特拉）和距离向量路由选择协议都不能适用于整个网络，原因有如下两点：

1. 网络规模。当今的因特网由数亿台主机组成。在这些主机中存储的路由选择信息显然需要巨大容量的内存。并且求出所有路由器之间的链路开销需要巨大的负担，并且距离向量算法可能永远无法收敛。
2. 管理自治。因特网是ISP的网络，其中每个ISP都有它自己的路由器网络。ISP通常希望按自己的意愿运行路由器(如在自己的网络中运行它所选择的某种路由选择算法)，或对外部隐藏其网络的内部组织面貌。

自治系统（AS）：一个自治系统由其全局唯一的AS号(ASN)所标识。每个AS由一组通常处在相同管理控制下的路由器组成。 通常在一个ISP中的路由器以及互联它们的链路构成一个AS；也有某些ISP将网络划分为多个AS；也有一个一级ISP在整个网络使用一个庞大的AS，其他子ISP再进行划分为多个AS。

#### 开放最短路优先(OSPF)

OSPF是一种链路状态协议，它使用洪泛链路状态信息和Dijkstra最低开销路径算法。 使用OSPF, —台路由器构建了一幅关于整个自治系统的完整拓扑图(即一幅图)。于是, 每台路由器在本地运行Dijkstra的最短路径算法，以确定一个以自身为根节点到所有子网的最短路径树。

各条链路开销是由网络管理员配置，管理员也许会选择将所有链路开销设为1,因而实现了最少跳数路由选择，或者可能会选择将链路权值按与链路容量成反比来设置，从而不鼓励流量使用低带宽链路。

使用OSPF时，路由器向自治系统内所有其他路由器广播路由选择信息，而不仅仅是向其相邻路由器广播。每当一条链路的状态发生变化时(如开销的变化或连接/中断状态的变化)，路由器就会广播链路状态信息。即使链路状态未发生变化，它也要周期性地 (至少每隔30 min一次)广播链路状态 。

优点：

1. 安全。路由器间的OSPF报文能够配置两类鉴别，即简单的和MD5的。使用简单的鉴别，每台路由器配置相同的口令。当一台路由器发送一个OSPF分组，它以明文方式包括了口令 。MD5的要对比报文携带的MD5散列和路由去计算出来的MD5值。

2. 多条相同开销的路径。当到达某目的地的多条路径具有相同的开销时，OSPF允许使用多条路径。

3. 对单播与多播路由选择的综合支持。

4. 支持在单个AS中的层次结构。一个OSPF自治系统能够层次化地配置多个区域。 每个区域都运行自己的OSPF链路状态路由选择算法，区域内的每台路由器都向该区域内的所有其他路由器广播其链路状态。
   
   ![z74TcGt](https://i.imgur.com/z74TcGt.png)
   
   **区边界路由器**：即在子区中，又在主干网络区中。“汇总” 到达所在区网络的距离, 通告给其他区边界路由器。
   
   **主干路由器**( Backbone Routers):在主干区内运行OSPF路由算法。
   
   **AS边界路由器**：连接其他AS。

## 5.4 ISP之间的路由选择：BGP

BGP(Broder Bateway Protocal)：边界网关协议。

![e5aPMzO](https://i.imgur.com/e5aPMzO.png)

![D12iERm](https://i.imgur.com/D12iERm.png)

![OD6gxKj](https://i.imgur.com/OD6gxKj.png)

![X3vQxyA](https://i.imgur.com/X3vQxyA.png)

![frOiLpG](https://i.imgur.com/frOiLpG.png)

![nl1VFjQ](https://i.imgur.com/nl1VFjQ.png)

![HTNKaJy](https://i.imgur.com/HTNKaJy.png)

#### **热土豆路由选择依据的思想**

对于路由器lb,尽可能快地将分组送出其AS (更明 确地说，用可能的最低开销)，而不担心其AS外部到目的地的余下部分的开销。就 “热 土豆路由选择”名称而言，分组被类比为烫手的热土豆。因为它烫手，你要尽可能快地将它传给另一个人(另一个AS)。

## 5.6 ICMP：英特网控制报文协议

ICMP，被主机和路由器用来彼此沟通网络层的信息，典型的用途是差错报告。

例如HTTP会话中的“404 网络不可到达“等。

在某个位置，IP路由器不能找到一条通往HTTP请求中所指定的主机的路径，该路有趣就会向你的主机生成并发出一个ICMP报文以提示该错误。

ICMP报文是作为IP有效承载的，就像TCP和UDP报文段作为IP有效承载那样。ICMP有一个类型字段和一个编码字段，并且包含引起该IP数据报的首部和前8个字节。

![5psvkXj](https://i.imgur.com/5psvkXj.png)

Ping：ping程序发送一个ICMP类型8编码0的报文到指定主机，看到回显请求，目的主机发回一个类型0编码0的ICMP报文。

Traceroute:由ICMP报文实现。

- 源主机向目的主机发送一系列普通IP数据报，每个数据报包含一个不可到达的UDP端口号的UDP报文段

- 第一个数据报的TTL为1，第二个为2，以此类推

- 当第n个书记报到达第n台路由器，刚好过期，路由器丢弃该数据报，并发送一个ICMP警告报文给源主机（类型11，编码为0），该告警报文包含了路由器的名字和它的IP地址。

- 当目的主机收到报文时，由于端口不可到达，它向源主机发送一个端口不可到达的ICMP报文（类型3，编码3），当源主机接收到该报文，它就停止发送类似数据报。

